name: Sync All Kaggle Notebooks
on: [workflow_dispatch]

jobs:
  sync:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          pip install --upgrade pip
          pip install kaggle==1.6.0 nbconvert ipython

      - name: Configure Kaggle
        run: |
          mkdir -p ~/.kaggle
          echo '{
            "username":"adelanseur",
            "key":"${{ secrets.KAGGLE_KEY }}",
            "allow_private":true
          }' > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json

      - name: Sync Notebooks
        run: |
          mkdir -p "Kaggle-top-3-notebook"
          
          # Clean previous files
          rm -f Kaggle-top-3-notebook/*.ipynb
          rm -f Kaggle-top-3-notebook/*.html
          
          # Download and rename notebooks
          kaggle kernels pull adelanseur/manga-sales-eda-ml -p "Kaggle-top-3-notebook"
          mv "Kaggle-top-3-notebook/manga-sales-eda-ml.ipynb" "Kaggle-top-3-notebook/1_Manga_Sales.ipynb"
          
          kaggle kernels pull adelanseur/second-notebook -p "Kaggle-top-3-notebook"
          mv "Kaggle-top-3-notebook/second-notebook.ipynb" "Kaggle-top-3-notebook/2_Time_Series.ipynb"
          
          kaggle kernels pull adelanseur/third-notebook -p "Kaggle-top-3-notebook"
          mv "Kaggle-top-3-notebook/third-notebook.ipynb" "Kaggle-top-3-notebook/3_Image_Classification.ipynb"

      - name: Convert to HTML
        run: |
          cd Kaggle-top-3-notebook
          for notebook in *.ipynb; do
            jupyter nbconvert "$notebook" --to html
            echo "Converted $notebook to HTML"
          done
          ls -la *.html
          cd ..

      - name: Commit and Push
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add .
          git commit -m "Update: All Notebooks $(date +'%Y-%m-%d %H:%M')"
          git push
